# การทดลองที่ 7 เรื่องการเขียนและพัฒนาโปรแกรมเพื่อรันบนไมโครคอนโทรเลอร์ 

## วัตถุประสงค์
*  เพื่อให้ศึกษาและเข้าใจถึงการเขียนโปรแกรมที่ใช้ในการรันคำสั่งบนไมโครคอนโทรเลอร์
*  เพื่อเป็นการนำความรู้ที่ได้นำทดลองและพัฒนาในการเขียนโปรแกรมเพื่อรันบนไมโครคอนโทรเลอร์ 

## อุปกรณ์ที่ใช้
1.	ไมโครคอนโทรเลอร์ เช่น ESP_01
2.	USB 
3.	USB to Serial Port
4.	Adapter
5.	หลอด LED
6.	โทรศัพท์มือถือ
7.	อุปกรณ์ที่ใช้ในเขียนโปรแกรม เช่น คอมพิวเตอร์ เป็นต้น


## ศึกษาข้อมูลเบื้องต้น
1. การติดตั้งโปรแกรม
   * https://www.youtube.com/watch?v=ocrGdJoP90Y
2. ข้อมูลของไมโครคอนโทรเลอร์
   * [PlatformIO]( https://platformio.org/ )
   * [ESP_01](https://docs.platformio.org/en/latest/boards/espressif8266/esp01_1m.html)
3. การเขียนโปรแกรม
   * [การเขียนโปรแกรมโดยใช้ภาษาของ Arduino](http://www.sbt.ac.th/new/sites/default/files/TNP_Unit_3.pdf?fbclid=IwAR3S3sb5SMzHRW5Dq7SKVO-rd_HUcSAs75nkiaa3eNkx-PtzpSwNbk3Nzgs)
4. Code ที่ใช้ในการทดลองนี้
   * [code]( https://github.com/phornnipha/lab-7/blob/main/lab_7.cpp)

## วิธีการทำการทดลอง
  1.เริ่มจากการต่อ USB ที่ต่อเชื่อมกับคอมพิวเตอร์ เข้ากับตัว USB to Serial Port
  
  2.นำ Adapterต่อเข้าทาง Serial Port
  
  3.นำ ไมโครคอนโทรเลอร์ (ESP_01) ต่อเข้ากับ Serial Port ของ Adapter
  
  4.ต่อหลอด LED ที่พอร์ต 0 และ 2
  
  5.upload code ของโปรแกรมลงในโฟลเดอร์ของคอมพิวเตอร์
   ```javascript
  #include <Arduino.h>
#include <ESP8266WiFi.h>
//#include <WiFiClient.h>
#include <ESP8266WebServer.h>

//ssid ip address กับ password ของ wifi ที่สร้าง

const char* ssid = "Phornnipha-wifi";                           //ตั้งชื่อ wifi                        
const char* password = "987654321";                             //ตั้ง password

IPAddress local_ip(192, 168, 1, 1);
IPAddress gateway(192, 168, 1, 1);
IPAddress subnet(255, 255, 255, 0);

ESP8266WebServer server(80);

int cnt = 0;

void setup(void){
     Serial.begin(115200);                                        // เริ่มการทำงาน Serial Monitor(การกำหนดอัตรการส่งข้อมูล)

     pinMode(0, INPUT);                                           //การกำหนดขาที่เชื่อมต่อวงจรให้เป็นพอร์ต input
     pinMode(2, OUTPUT);                                          //การกำหนดขาที่เชื่อมต่อวงจรให้เป็นพอร์ต output
        
     Serial.println("\n\n\n");                               
     int val = digitalRead(0);                                     //กำหนดให้ val = ค่าที่อ่านข้อมูลเข้าพอร์ตที่input
     Serial.printf("read=== %d\n", val);                           //แสดงค่าออกมา val = 0 หรือ 1 ตามค่าที่อ่านข้อมูลเข้าพอร์ตที่input
          
        if(val==1) 
               Serial.println("---input---");                      //การพิมพ์ข้อมูลไปยังพอร์ตและขึ้นบรรทัดใหม่
               Serial.begin(115200);

                WiFi.softAP(ssid, password);
                WiFi.softAPConfig(local_ip, gateway, subnet);
                delay(1000);                                      //เป็นการหน่วงเวลาตามค่าที่กำหนด มีหน่วยเป็น ms

                server.onNotFound([]() {
                        server.send(404, "text/plian", "Path Not Found");
               });
               server.on("/", []() {
                        cnt++;
                        String msg = "Hello cnt: ";
                        msg += cnt;
                        server.send(200, "text/plain", msg);
                        digitalWrite(2, LOW);                  //เขียนข้อมูลออกพอร์ตที่output
                        delay(1000);         
                });
                
                server.begin();
                Serial.println("server started");    
        
        } else {
               Serial.println("---no input---");
               Serial.begin(115200);
        
               cnt++;
               Serial.printf("number:%d\n",cnt);
               if((cnt % 2 == 0) {                              // % จะเป็นการหารเอาเศษ
                      Serial.println("==LED ON==");         
                      digitalWrite(2, HIGH);                    //หลอดไฟ LED ติด
               } else {
                      Serial.println("==LED OFF==");
                      digitalWrite(2, LOW);                     //หลอดไฟ LED ดับ
               }
               int p = (cnt % 4)+1;
               int s = p * 1000;
               delay(s);
	             
        }
}

void loop(){                                                    //เรียกใช้งาน wifi ที่ set up ไว้
	server.handleClient();
	
}
 ```
  
  6.ทำการเปิดโปรแกรม( Command Prompt )เพื่อที่จะทำการรัน โดยเข้าโฟลเดอร์ที่บันทึกตัวอย่างโปรแกรมเอาไว้ แล้วพิมพ์ **cd ชื่อไฟล์ของโปรแกรม** 
  
  
  7.รันคำสั่ง **pio run -t upload** เพื่อที่จะ upload โปรแกรม  ลงใน ESP_01
 
  8.ในขณะที่ทำการรันคำสั่ง ให้กดปุ่มสีดำค้างไว้แล้วกดปุ่มแดง(reset) เพื่อให้ ESP_01 รับโปรแกรมใหม่เข้าไป
 
  9.รันคำสั่ง **pio device monitor** เพื่อดูผลที่แสดงผลออกมาบน monitor 
  
  10.นำสายสีขาว แตะที่เส้นสีดำ
  
  11.นำสายสีขาว แตะที่เส้นสีแดง 
  
  12.กดปุ่มสีดำ
  
  13.หลังทำการทดลองขั้นที่ 11-13 และลองใช้โทรศัพท์มือถือค้นหาไวไฟหลังทำแต่ละขั้นเสร็จ
  
  14.ลองกดปุ่มสีแดง(reset) 
  
  15.บันทึกผลการทดลอง

## การบันทึกผลการทดลอง
* จากการทดลองหลังจากรันคำสั่ง pio device monitor จะเห็นผลที่แสดงออกมาบน monitor จะแสดงผล **read===1**
* หลังจากการนำสายสีขาวแตะที่เส้นสีดำ หรือ กดปุ่มสีดำ จะเห็นผลที่แสดงออกมาบน monitor จะแสดงผล **read===0**   
**---no input---**  และจะแสดงผลเป็น **number1** โดยเลขหลังคำว่าnumberจะเพิ่มไปเรื่อย ๆ ซึ่งหลอดไฟ LED จะติดเมื่อหลังคำว่าnumberเป็นเลขที่ 2 หารลงตัวหรือ เป็นเลขคู่ และ หลอดไฟ LED จะดับเมื่อหลังคำว่าnumberเป็นเลขที่ 2 หารไม่ลงตัวหรือ เป็นเลขคี่ 
* หลังจากการนำสายสีขาว แตะที่เส้นสีแดง จะเห็นผลที่แสดงออกมาบน monitor จะแสดงผล **read===1**
  , **---input---** , **server started** เเละเมื่อทำการใช้โทรศัพท์มือถือค้นหาไวไฟ จะค้นพบตัวไวไฟตามชื่อที่ตั้งไว้และหลอดไฟ LED จะดับ 

## อภิปรายผลการทดลอง
   * จากการทดลองที่ 7 เรื่อง การเขียนและพัฒนาโปรแกรมเพื่อรันบนไมโครคอนโทรเลอร์ เราสามารถที่จะเขียนโปรแกรมที่ใช้ในการรันบนไมโครคอนโทรเลอร์ โดยการทดลองนี้เมื่อรันคำสั่ง ลงไปบนตัวไมโครคอนโทรเลอร์ ( ESP_01 ) หลังจากรันคำสั่งหมดแล้ว ตัวโปรแกรมจะแสดงผลออกมาบน monitor เป็น read===1 โดยตัวโปรแกรมจะทำงานโดยจะเช็คที่พอร์ต 0 ว่ามีตัว input หรือไม่ และจะไปแสดงผลลัพธ์ที่พอร์ต 2 เมื่อที่พอร์ต 2 ต่อหลอดไฟ LED โดยเมื่อตัว ****input มีค่าเป็น 1**** จะแสดงผลออกมาบน monitor เป็น "read===1"  ,  "---input---" , "server started" และโปรแกรมสร้างไวไฟแอคเซสพอยต์  และเมื่อทำการใช้โทรศัพท์มือถือค้นหาไวไฟ จะค้นพบไวไฟตามชื่อไวไฟตามที่ตั้งไว้คือ "Phornnipha-wifi" และมีรหัสคือ "987654321" และหลอดไฟ LED จะดับ และเมื่อ ****input มีค่าเป็น 0**** จะเห็นผลที่แสดงออกมาบน monitor เป็น "read===0"  , '---no input---"  และจะแสดงผลเป็น **number1** โดยเลขหลังคำว่า number จะมีค่าเพิ่มขึ้นไปเรื่อย ๆ และหลอดไฟ LED จะติดเมื่อหลังคำว่า number เป็นเลขที่ 2 หารลงตัวหรือ เป็นเลขคู่ และ หลอดไฟ LED จะดับเมื่อหลังคำว่า number เป็นเลขที่ 2 หารไม่ลงตัวหรือ เป็นเลขคี่ ดังนั้น จะเห็นเป็นไฟกะพริบที่หลอดไฟ LED โดยหลอดไฟ LED จะดับ 2 S  จะสว่าง 3 s จะอีกดับ 4 s และจะสว่าง 1 S วนไปเรื่อยๆ 

## คำถามหลังการทดลอง 
   * จากการทดลองนี้ เมื่อนำสายสีขาวแตะที่เส้นสีดำ  ทำไมถึงเห็นผลที่แสดงออกมาบน monitor จะแสดงผล read===0
     * เพราะว่าสายสีดำ เป็นสาย ground ซึ่งมีค่าแรงดันไฟฟ้าเป็นศูนย์ เมื่อนำสายไฟสีขาวไปจิ้มจึงแสดงค่าเป็น 0 หรือไม่มี input 
